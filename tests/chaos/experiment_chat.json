{
    "title": "Chat Application Chaos Experiments",
    "description": "Verify Chat application resilience under various failure conditions",
    "tags": ["chat", "whatsapp", "messaging", "resilience", "chaos"],
    "steady-state-hypothesis": {
        "title": "Service is healthy and messages can be sent",
        "probes": [
            {
                "name": "health-check-responds",
                "type": "probe",
                "tolerance": 200,
                "provider": {
                    "type": "http",
                    "url": "${TARGET_URL}/health",
                    "timeout": 5
                }
            },
            {
                "name": "can-send-message",
                "type": "probe",
                "tolerance": [200, 201, 404],
                "provider": {
                    "type": "http",
                    "url": "${TARGET_URL}/api/v1/messages",
                    "method": "POST",
                    "headers": {
                        "Content-Type": "application/json",
                        "Authorization": "Bearer ${TEST_TOKEN}"
                    },
                    "arguments": {
                        "recipient_id": "chaos_test_user",
                        "content": "Chaos test message",
                        "type": "text"
                    },
                    "timeout": 10
                }
            },
            {
                "name": "message-latency-acceptable",
                "type": "probe",
                "tolerance": true,
                "provider": {
                    "type": "python",
                    "module": "tests.chaos.probes",
                    "func": "check_message_latency",
                    "arguments": {
                        "url": "${TARGET_URL}/api/v1/messages",
                        "max_latency_ms": 500
                    }
                }
            }
        ]
    },
    "method": [
        {
            "type": "action",
            "name": "simulate-network-partition",
            "provider": {
                "type": "python",
                "module": "tests.chaos.actions",
                "func": "simulate_network_partition",
                "arguments": {
                    "partition_duration_seconds": 30,
                    "affected_percentage": 0.5
                }
            },
            "pauses": {
                "after": 5
            }
        },
        {
            "type": "probe",
            "name": "verify-messages-queued",
            "tolerance": true,
            "provider": {
                "type": "python",
                "module": "tests.chaos.probes",
                "func": "verify_message_queue_growth",
                "arguments": {
                    "url": "${TARGET_URL}/api/v1/admin/queue-stats"
                }
            }
        },
        {
            "type": "action",
            "name": "restore-network",
            "provider": {
                "type": "python",
                "module": "tests.chaos.actions",
                "func": "restore_network"
            },
            "pauses": {
                "after": 10
            }
        },
        {
            "type": "probe",
            "name": "verify-messages-delivered",
            "tolerance": true,
            "provider": {
                "type": "python",
                "module": "tests.chaos.probes",
                "func": "verify_message_delivery",
                "arguments": {
                    "url": "${TARGET_URL}/api/v1/messages",
                    "timeout_seconds": 60
                }
            }
        },
        {
            "type": "action",
            "name": "simulate-database-slowdown",
            "provider": {
                "type": "python",
                "module": "tests.chaos.actions",
                "func": "inject_database_latency",
                "arguments": {
                    "latency_ms": 1000,
                    "duration_seconds": 30
                }
            },
            "pauses": {
                "after": 5
            }
        },
        {
            "type": "probe",
            "name": "verify-service-degrades-gracefully",
            "tolerance": [200, 201, 503],
            "provider": {
                "type": "http",
                "url": "${TARGET_URL}/api/v1/messages",
                "method": "POST",
                "headers": {
                    "Content-Type": "application/json",
                    "Authorization": "Bearer ${TEST_TOKEN}"
                },
                "arguments": {
                    "recipient_id": "chaos_test_user",
                    "content": "Test during DB slowdown",
                    "type": "text"
                },
                "timeout": 15
            }
        },
        {
            "type": "action",
            "name": "simulate-presence-service-failure",
            "provider": {
                "type": "python",
                "module": "tests.chaos.actions",
                "func": "kill_presence_service",
                "arguments": {
                    "duration_seconds": 30
                }
            },
            "pauses": {
                "after": 5
            }
        },
        {
            "type": "probe",
            "name": "verify-messaging-works-without-presence",
            "tolerance": [200, 201],
            "provider": {
                "type": "http",
                "url": "${TARGET_URL}/api/v1/messages",
                "method": "POST",
                "headers": {
                    "Content-Type": "application/json",
                    "Authorization": "Bearer ${TEST_TOKEN}"
                },
                "arguments": {
                    "recipient_id": "chaos_test_user",
                    "content": "Test without presence",
                    "type": "text"
                },
                "timeout": 10
            }
        }
    ],
    "rollbacks": [
        {
            "type": "action",
            "name": "restore-all-services",
            "provider": {
                "type": "python",
                "module": "tests.chaos.actions",
                "func": "restore_all_services"
            }
        }
    ]
}
